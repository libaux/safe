import{_ as e,Y as t,aL as a,g as l,n as o,R as s,h as n,O as i,a as r,s as d,r as m,b as u,C as p,c,w as f,aM as h,i as g,aN as b,K as D,k as y,o as _,l as x,m as k,t as w,p as v,v as C,D as V,x as S,V as T,z as I,u as M,a0 as U}from"./index-nI17xpur.js";import{_ as A}from"./uni-easyinput.Bgc1tsO3.js";import{_ as F}from"./uni-forms-item.Dcp4oYwL.js";import{_ as O}from"./uni-data-checkbox.CKcvFTgL.js";import{_ as P}from"./uni-number-box.DgaSC5-Q.js";import{_ as $}from"./uni-forms.C-pi59MJ.js";import{_ as j}from"./uni-popup-dialog.DJfQkEmy.js";import{v as B}from"./uni-id-users.DAe4ZmBF.js";import"./uni-load-more.l5YQeopO.js";const L=t.database();function z(e){let t={};for(let a in B)e.includes(a)&&(t[a]=B[a]);return t}const N={components:{Check:a},data:()=>({showFoldForm:!1,formData:{nickname:"",notename:"",comment:"",password:"",role:[],tags:[],authorizedApp:[],mobile:"",vip_date:0,vip_cnts:0,status:0},oldData:{},belongUser:{},errorMobile:!1,isClearBelongInput:!0,belongMobile:"",addVipCnt:0,rules:{...z(["nickname","mobile","password"]),status:{rules:[{format:"bool"}]}},roles:[],userId:"",appList:[],unknownAppids:[],formDataId:""}),onLoad(e){const t=e.id;this.formDataId=t;let a=l("uni-id-pages-userInfo")||{};this.userId=a._id,this.getDetail(t)},computed:{unknownAppidsCom(){let e="";return this.unknownAppids.map(((t,a)=>{e+=t,a!==this.unknownAppids.length-1&&(e+="ã€")})),e},userStateTips(){return 0===this.formData.status?{style:"margin: -15px;",text:"åœç”¨ä¸­"}:this.formData.status?{style:"margin: -15px;",text:"å¯ç”¨ä¸­"}:{style:"margin: -15px; color:#ff5558;font-weight: bold",text:"åœç”¨ä¸­"}},dialogStyle(){const e=new Date(Math.max(this.oldData.vip_date,(new Date).getTime())),t=new Date(this.formData.vip_date),a=Math.round((t-e)/864e5),l=new Date(this.oldData.vip_date),o=new Date(Math.max(this.formData.vip_date,(new Date).getTime())),s=Math.round(Math.abs(o-l)/864e5);let n={type:"info",title:"æç¤º",content:""};return this.addVipCnt>0?(n.type="warn",n.title="ğŸ‘‘ æƒç›Šå¢åŠ ",n.content+=`ç¡®è®¤å¢åŠ  ${this.addVipCnt} ä¸ªä½¿ç”¨æ¬¡æ•°ï¼Ÿ\n`):this.addVipCnt<0&&(n.type="error",n.title="ğŸ“› æƒç›Šæ‰£é™¤",n.content+=`ç¡®è®¤æ‰£é™¤ ${Math.abs(this.addVipCnt)} ä¸ªä½¿ç”¨æ¬¡æ•°ï¼Ÿ\n`),t>e?(n.type="warn",n.title="ğŸ‘‘ ä¼šå‘˜å¢åŠ ",n.content+=`ç¡®è®¤å¢åŠ  ${a} å¤©ä¼šå‘˜ï¼Ÿ\n`):t<l&&this.oldData.vip_date>Date.now()&&(n.type="error",n.title="ğŸ“› ä¼šå‘˜å–æ¶ˆ",n.content+=`ç¡®è®¤å–æ¶ˆ ${s} å¤©ä¼šå‘˜ï¼Ÿ\n`),0==this.formData.status&&(n.type="error",n.title="ğŸš« åœç”¨è´¦æˆ·",n.content+="åœç”¨è´¦æˆ·ï¼Œå¹¶å†»ç»“å…¶æ‰€æœ‰æœåŠ¡ï¼\n"),this.formData.password!=this.oldData.password?(n.type="error",n.content+="ç¡®è®¤ä¿®æ”¹ç”¨æˆ·å¯†ç ï¼Ÿ\n"):this.formData.password||(n.type="error",n.content+="ç”¨æˆ·å¯†ç ä¸ºç©ºï¼Œè¯·é‡æ–°è¾“å…¥\n"),this.formData.belong!=this.oldData.belong&&(n.type="error",n.content+="ç¡®è®¤è½¬ç§»å½’å±äººï¼Ÿ\n"),n.content||(n.content="æœªä¿®æ”¹é‡è¦ä¿¡æ¯"),n},vipPickerStyle(){const e={color:"#505050e6",size:"14px",weight:"bold"},t=new Date(Math.max(this.oldData.vip_date,(new Date).getTime()));return this.formData.vip_date>t?e.color="#ffb752":this.formData.vip_date<this.oldData.vip_date&&this.oldData.vip_date>Date.now()&&(e.color="#ff5558"),e}},methods:{handleStatus(e){this.formData.status=e.detail.value},handleOpenDatePicker(){this.$refs.datePicker.show()},handleAlertDialog(){this.$refs.alertDialog.open()},gotoAppList(){o({url:"../app/list"})},gotoTagList(){o({url:"../tag/list"})},gotoTagAdd(){o({url:"../tag/add",events:{refreshCheckboxData:()=>{this.$refs.checkboxTags.loadData()}}})},dateTimeSelect(e){const t=new Date(this.oldData.vip_date),a=36e5*t.getHours()+6e4*t.getMinutes()+1e3*t.getSeconds()+t.getMilliseconds();this.formData.vip_date=e+a},handleVIPday(){const e=new Date,t=new Date(this.formData.vip_date);let a=new Date(Math.max(e.getTime(),t.getTime()));this.formData.vip_date=a.getTime()+864e5},handleVIPmonth(){const e=new Date,t=new Date(this.formData.vip_date);let a=new Date(Math.max(e.getTime(),t.getTime()));this.formData.vip_date=a.setMonth(a.getMonth()+1)},resetOld_Vip_date(){let e=new Date(this.oldData.vip_date);this.formData.vip_date=e.getTime()},async trigger(){this.showFoldForm=!this.showFoldForm},async handleBelongSearch(){if(this.belongMobile){const e=t.importObject("libauxAdmin"),a=await e.findUserByMobile(this.belongMobile);this.belongUser=a.data[0],this.belongUser?this.formData.belong=this.belongUser._id:this.errorMobile=!0}else this.errorMobile=!0;this.isClearBelongInput=!1},async clearBelongInput(){this.belongUser={},this.isClearBelongInput=!0},refleshPassword(){this.formData.password=this.oldData.password},submitForm(){this.$refs.form.submit()},submit(e){const{errors:t}=e.detail;if(t)return;s({title:"ä¿®æ”¹ä¸­...",mask:!0}),this.formData.vip_cnts+=this.addVipCnt;let a=JSON.parse(JSON.stringify(this.formData));for(let l in this.oldData)JSON.stringify(this.oldData[l])==JSON.stringify(a[l])&&delete a[l];if("boolean"==typeof a.status&&(a.status=Number(!a.status)),"{}"==JSON.stringify(a))return n(),void i();a.uid=this.formDataId,this.$request("updateUser",a).then((()=>{r({title:"ä¿®æ”¹æˆåŠŸ"});const e=this.getOpenerEventChannel();e.emit&&e.emit("refreshData"),setTimeout((()=>i()),500)})).catch((e=>{d({content:e.message||"è¯·æ±‚æœåŠ¡å¤±è´¥",showCancel:!1})})).finally((()=>{n()}))},getDetail(e){L.collection("libraux-users").doc(e).field("nickname,notename,school,mobile,password,belong,comment,tags,status,role,vip_date,vip_cnts,dcloud_appid as authorizedApp").get().then((e=>{const t=e.result.data[0];t&&(void 0===t.status&&(t.status=!0),0===t.status&&(t.status=!0),1===t.status&&(t.status=!1),this.formData=Object.assign(this.formData,t),this.formData.notename||(this.formData.notename=this.formData.nickname),this.oldData=JSON.parse(JSON.stringify(this.formData)),this.$hasRole("admin")&&(this.loadAppList(this.formData.authorizedApp),this.loadroles()))})).catch((e=>{d({content:e.message||"è¯·æ±‚æœåŠ¡å¤±è´¥",showCancel:!1})})).finally((()=>{}))},loadroles(){L.collection("uni-id-roles").limit(500).get().then((e=>{const t=[];this.roles=e.result.data.map((e=>(t.push(e.role_id),{value:e.role_id,text:e.role_name,disable:"admin"==e.role_id}))),-1===t.indexOf("admin")&&this.roles.unshift({value:"admin",text:"è¶…çº§ç®¡ç†å‘˜",disable:!0})})).catch((e=>{d({title:"æç¤º",content:e.message,showCancel:!1})}))},loadAppList(e){L.collection("opendb-app-list").limit(500).get().then((t=>{let a=t.result.data.map(((e,t)=>({value:e.appid,text:e.name})));a||(a=[]),e.map((e=>{a.find((t=>t.value===e))||(this.unknownAppids.push(e),a.push({value:e,text:`æœªçŸ¥åº”ç”¨${e}`}))})),this.appList=a})).catch((e=>{d({title:"æç¤º",content:e.message,showCancel:!1})}))},parseUserStatus:e=>0===e?"å¯ç”¨":1===e?"ç¦ç”¨":2===e?"å®¡æ ¸ä¸­":3===e?"å®¡æ ¸æ‹’ç»":4===e?"å·²æ³¨é”€":void 0!==e?"æœªçŸ¥":"å¯ç”¨"}},J=()=>{h((e=>({bd6e374c:e.vipPickerStyle.color,dcc39fac:e.vipPickerStyle.size,ad33a73e:e.vipPickerStyle.weight})))},R=N.setup;N.setup=R?(e,t)=>(J(),R(e,t)):J;const q=e(N,[["render",function(e,t,a,l,o,s){const n=m(u("uni-easyinput"),A),i=g,r=m(u("uni-forms-item"),F),d=T,h=p("el-avatar"),B=p("el-text"),L=p("el-button"),z=p("Check"),N=p("el-icon"),J=m(u("uni-data-checkbox"),O),R=m(u("uni-number-box"),P),q=I,E=m(u("uni-datetime-picker"),b),H=m(u("uni-icons"),D),K=M,W=m(u("uni-forms"),$),Y=U,G=m(u("uni-popup-dialog"),j),Q=m(u("uni-popup"),y);return _(),c(i,{class:""},{default:f((()=>[x(i,{class:"uni-container"},{default:f((()=>[x(i,{class:"edit-page-container"},{default:f((()=>[x(W,{calss:"edit-forms",ref:"form",modelValue:o.formData,"onUpdate:modelValue":t[14]||(t[14]=e=>o.formData=e),rules:o.rules,validateTrigger:"bind",onSubmit:s.submit},{default:f((()=>[x(r,{name:"notename",label:"å¤‡æ³¨åç§°"},{default:f((()=>[x(i,{style:{display:"grid","justify-content":"space-between","grid-template-columns":"auto auto"}},{default:f((()=>[x(n,{modelValue:o.formData.notename,"onUpdate:modelValue":t[0]||(t[0]=e=>o.formData.notename=e),clearable:!1,placeholder:"ä»…ç®¡ç†å‘˜å¯è§"},null,8,["modelValue"]),x(i,{style:{margin:"auto 0","margin-left":"15px"}},{default:f((()=>[k(w(o.formData.school),1)])),_:1})])),_:1})])),_:1}),x(r,{name:"status",label:"ç”¨æˆ·çŠ¶æ€"},{default:f((()=>[x(i,{class:"uni-forms-item-flex-center-x"},{default:f((()=>[x(i,{class:"uni-forms-item-flex-center-x"},{default:f((()=>[Number(o.formData.status)<2?(_(),c(d,{key:0,style:{transform:"scale(0.6)","transform-origin":"0%"},onChange:s.handleStatus,checked:!!o.formData.status,disabled:o.formDataId===o.userId},null,8,["onChange","checked","disabled"])):(_(),c(i,{key:1,class:"uni-form-item-empty"},{default:f((()=>[k(w(s.parseUserStatus(o.formData.status)),1)])),_:1})),o.formDataId===o.userId?(_(),v("span",{key:2,style:{margin:"-15px"}},"æ— æ³•ç¦ç”¨")):(_(),v("span",{key:3,style:C(s.userStateTips.style)},w(s.userStateTips.text),5))])),_:1}),V("span",null,w(o.formData.mobile),1),V("span",{class:"link-btn reset-password-btn",onClick:t[1]||(t[1]=(...e)=>s.trigger&&s.trigger(...e))},"æ›´å¤šæ“ä½œ")])),_:1})])),_:1}),o.showFoldForm?(_(),c(r,{name:"password",label:"è®¾ç½®å¯†ç ",key:"password"},{default:f((()=>[x(n,{modelValue:o.formData.password,"onUpdate:modelValue":t[2]||(t[2]=e=>o.formData.password=e),icon:"",style:C(o.formData.password!=o.oldData.password?"font-weight:bold;":""),prefixIcon:"reload",onIconClick:s.refleshPassword,clearable:!0,placeholder:"è¯·è¾“å…¥æ–°çš„å¯†ç "},null,8,["modelValue","style","onIconClick"])])),_:1})):S("",!0),o.showFoldForm?(_(),c(r,{key:1,name:"nickname",label:"ç”¨æˆ·æ˜µç§°"},{default:f((()=>[x(i,{style:{display:"grid","justify-content":"space-between","grid-template-columns":"auto auto"}},{default:f((()=>[x(n,{modelValue:o.formData.nickname,"onUpdate:modelValue":t[3]||(t[3]=e=>o.formData.nickname=e),clearable:!1,placeholder:"ç”¨æˆ·ç«¯å¯è§"},null,8,["modelValue"])])),_:1})])),_:1})):S("",!0),o.showFoldForm?(_(),c(r,{key:2,label:"å½’å±è½¬ç§»"},{default:f((()=>[x(i,{class:"uni-forms-item-flex-center-x"},{default:f((()=>[x(i,{class:"flex-item",style:{width:"255px"}},{default:f((()=>{var e;return[x(i,{style:{width:"177px"}},{default:f((()=>[x(n,{modelValue:o.belongMobile,"onUpdate:modelValue":[t[4]||(t[4]=e=>o.belongMobile=e),s.clearBelongInput],maxlength:"11",clearable:"",type:"number",onClear:s.clearBelongInput,onConfirm:s.handleBelongSearch,placeholder:"è¯·è¾“å…¥æ¥æ”¶äººçš„æ‰‹æœºå·"},null,8,["modelValue","onUpdate:modelValue","onClear","onConfirm"])])),_:1}),(null==(e=o.belongUser)?void 0:e.avatar)?(_(),c(h,{key:0,style:{"margin-left":"15px",height:"35px",width:"35px"},shape:"square",src:o.belongUser.avatar},null,8,["src"])):o.errorMobile&&!o.isClearBelongInput?(_(),c(i,{key:1,style:{"margin-left":"15px"}},{default:f((()=>[x(B,{type:"danger"},{default:f((()=>[k("æ— æ•ˆå·ç ")])),_:1})])),_:1})):S("",!0)]})),_:1}),x(i,{class:"button-top-margin380"},{default:f((()=>{var e;return[(null==(e=o.belongUser)?void 0:e.nickname)?(_(),c(L,{key:1,plain:"",round:"",style:{width:"50px"},onClick:s.handleBelongSearch},{default:f((()=>[x(N,null,{default:f((()=>[x(z)])),_:1})])),_:1},8,["onClick"])):(_(),c(L,{key:0,plain:"",round:"",style:{width:"50px"},onClick:s.handleBelongSearch},{default:f((()=>[k("æœç´¢")])),_:1},8,["onClick"]))]})),_:1})])),_:1})])),_:1})):S("",!0),this.$hasRole("admin")&&o.showFoldForm?(_(),c(r,{key:3,name:"authorizedApp",label:"å¯ç™»å½•åº”ç”¨"},{default:f((()=>[x(i,{class:"uni-forms-item-flex-center-x"},{default:f((()=>[x(J,{multiple:!0,modelValue:o.formData.authorizedApp,"onUpdate:modelValue":t[5]||(t[5]=e=>o.formData.authorizedApp=e),localdata:o.appList},null,8,["modelValue","localdata"]),V("span",{class:"link-btn",style:{"align-self":"flex-start","line-height":"24px"},onClick:t[6]||(t[6]=(...e)=>s.gotoAppList&&s.gotoAppList(...e))},"ç®¡ç†")])),_:1})])),_:1})):S("",!0),this.$hasRole("admin")&&o.showFoldForm?(_(),c(r,{key:4,name:"role",label:"è§’è‰²åˆ—è¡¨",class:"flex-center-x"},{default:f((()=>[x(J,{multiple:"",localdata:o.roles,modelValue:o.formData.role,"onUpdate:modelValue":t[7]||(t[7]=e=>o.formData.role=e)},null,8,["localdata","modelValue"])])),_:1})):S("",!0),x(r,{name:"comment",label:"æè¿°ä¿¡æ¯"},{default:f((()=>[x(n,{type:"textarea",modelValue:o.formData.comment,"onUpdate:modelValue":t[8]||(t[8]=e=>o.formData.comment=e),clearable:!1,placeholder:"ä»…ç®¡ç†å‘˜å¯è§"},null,8,["modelValue"])])),_:1}),x(r,{name:"tags",label:"åˆ†ç±»æ ‡ç­¾",labelWidth:"100",class:"flex-center-x"},{default:f((()=>[x(J,{ref:"checkboxTags",mode:"tag",multiple:"",selectedColor:"#d6b37b!important",selectedTextColor:"#fff!important",modelValue:o.formData.tags,"onUpdate:modelValue":t[9]||(t[9]=e=>o.formData.tags=e),collection:"uni-id-tag",field:"tagid as value, name as text"},null,8,["modelValue"]),this.$hasRole("admin")?(_(),c(i,{key:0,style:{"text-align":"center","align-self":"flex-start","line-height":"36px"}},{default:f((()=>[V("span",{class:"link-btn",onClick:t[10]||(t[10]=(...e)=>s.gotoTagAdd&&s.gotoTagAdd(...e))},"æ–°å¢"),V("span",{class:"link-btn",onClick:t[11]||(t[11]=(...e)=>s.gotoTagList&&s.gotoTagList(...e)),style:{"margin-left":"10px"}},"ç®¡ç†")])),_:1})):S("",!0)])),_:1}),x(r,{name:"vip_cnts",label:"å‰©ä½™æ¬¡æ•°"},{default:f((()=>[x(i,{class:"uni-forms-item-flex-center-x",style:{"max-width":"180px"}},{default:f((()=>[x(i,null,{default:f((()=>[k(w(o.formData.vip_cnts||0)+" æ¬¡ ",1)])),_:1}),x(i,{class:""},{default:f((()=>[x(R,{min:-999,max:999,step:5,modelValue:o.addVipCnt,"onUpdate:modelValue":t[12]||(t[12]=e=>o.addVipCnt=e)},null,8,["modelValue"])])),_:1})])),_:1})])),_:1}),x(r,{name:"vip_date",label:"ä¼šå‘˜å……å€¼"},{default:f((()=>[x(i,{class:"uni-forms-item-flex-center-x"},{default:f((()=>[x(i,{class:"flex-item"},{default:f((()=>[x(q,{onClick:s.handleOpenDatePicker},{default:f((()=>[k("åˆ°æœŸæ—¶é—´ï¼š")])),_:1},8,["onClick"]),x(E,{type:"date",border:!1,"clear-icon":!1,onChange:s.dateTimeSelect,style:{padding:"10px 10px 10px 5px"},ref:"datePicker",modelValue:o.formData.vip_date,"onUpdate:modelValue":t[13]||(t[13]=e=>o.formData.vip_date=e),"return-type":"timestamp"},null,8,["onChange","modelValue"]),x(H,{onClick:s.resetOld_Vip_date,type:"refreshempty",size:"17",style:{"font-weight":"bold",padding:"10px",color:"#3f3f3f"}},null,8,["onClick"])])),_:1}),x(i,{class:"flex-item button-top-margin"},{default:f((()=>[x(K,{onClick:s.handleVIPday,plain:"",style:{width:"80px","margin-right":"5px",transform:"scale(0.9)","transform-origin":"left"},type:"info",class:"mini-btn uni-button plain-button-reverse"},{default:f((()=>[k("1å¤©")])),_:1},8,["onClick"]),x(K,{type:"primary",onClick:s.handleVIPmonth,plain:"",style:{width:"80px",transform:"scale(0.9)","transform-origin":"right"},class:"mini-btn uni-button"},{default:f((()=>[k("1æœˆ")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue","rules","onSubmit"])])),_:1}),x(i,{class:"button-group"},{default:f((()=>[x(K,{class:"uni-button plain-button-reverse",type:"primary",onClick:s.handleAlertDialog,style:{width:"100px"}},{default:f((()=>[k("æäº¤")])),_:1},8,["onClick"]),x(Y,{"open-type":"navigateBack",style:{"margin-left":"20px"}},{default:f((()=>[x(K,{class:"uni-button",type:"default",plain:"",style:{width:"100px",color:"#494a4d","border-color":"#636468","background-color":"#fff"}},{default:f((()=>[k("å–æ¶ˆ")])),_:1})])),_:1})])),_:1})])),_:1}),x(Q,{ref:"alertDialog",type:"dialog"},{default:f((()=>[x(G,{type:s.dialogStyle.type,cancelText:"å–æ¶ˆ",confirmText:"ç¡®è®¤",title:s.dialogStyle.title,content:s.dialogStyle.content,onConfirm:s.submitForm},null,8,["type","title","content","onConfirm"])])),_:1},512)])),_:1})}],["__scopeId","data-v-b216162a"]]);export{q as default};
