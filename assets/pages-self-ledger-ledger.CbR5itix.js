import{_ as t,B as e,V as a,A as l,C as s,r as i,b as n,am as o,T as r,c as d,w as u,o as c,D as m,l as f,m as p,an as y,J as g,t as v,p as _,q as x,F as h,x as w,i as b,ao as $,ap as k,v as E}from"./index-BdDI6p4_.js";import{_ as F}from"./uni-dateformat.Dpn8wxxF.js";const M=t({__name:"ledger",setup(t){e((async()=>{const t=T(),e=C(),a=C(-1);j.value=await e,z.value=await a,await t}));const M=a.databaseForJQL(),D=l([]),j=l(0),z=l(0),B=l(!0),I=l(0);let J=l(!1);const P=async()=>{I.value+=1,await T(I.value),B.value=!1},T=async(t=0)=>{var e;if(J.value)return;const a=(null==(e=(await M.collection("libraux-ledger").where("uid==$cloudEnv_uid").field(`slice(bills, ${10*t}, 10) as partBills`).get()).data[0])?void 0:e.partBills)||[],l=[];for(let i of a){const t=V(i.payer);l.push(t)}const s=await Promise.all(l);for(let i in a)for(let t of s)a[i].payer==t._id&&(a[i].payer=t);D.value.push(...a),D.value.sort(((t,e)=>e.timestamp-t.timestamp)),a.length<10&&(J.value=!0)},V=async t=>(await M.collection("libraux-users").where({_id:t}).field("avatar,nickname,mobile,school,vip_cnts,vip_days").get()).data[0]||{},C=async(t=0)=>{var e;const l=a.databaseForJQL(),s=L(t);return(null==(e=(await l.collection("libraux-ledger").where("uid==$cloudEnv_uid").field(`reduce(filter(bills, "it", and(\n\t\t\t\t\t\t\tgte("$$it.timestamp", ${s[0]}),\n\t\t\t\t\t\t\tlt("$$it.timestamp", ${s[1]})\n\t\t\t\t\t\t\t)),\n\t\t\t\t\t\t\t0, add("$$value", "$$this.amount")) as sumVIP`).get()).data[0])?void 0:e.sumVIP)||0},L=(t=null)=>{const e=new Date,a=[];return null==t||(t>0&&t<=12?e.setMonth(t-1):t<0&&e.setMonth(e.getMonth()+t)),a[0]=new Date(e.getFullYear(),e.getMonth(),1).getTime(),a[1]=new Date(e.getFullYear(),e.getMonth()+1,0,23,59,59).getTime(),a};return(t,e)=>{const a=s("el-icon"),l=s("el-tooltip"),M=s("el-text"),I=s("el-statistic"),T=s("el-avatar"),V=i(n("uni-dateformat"),F),C=b,L=s("el-scrollbar"),Q=o("loading"),Y=o("infinite-scroll");return r((c(),d(L,{class:"scrollbar-container","infinite-scroll-distance":0,"infinite-scroll-delay":200},{default:u((()=>[m("div",{class:"statistic-card",style:{"text-align":"center"}},[f(I,{value:j.value},{title:u((()=>[m("div",{style:{display:"inline-flex","align-items":"center"}},[p("本月总计 "),f(l,{effect:"dark",content:"本月所有增加的天数与次数总和",placement:"top"},{default:u((()=>[f(a,{style:{"margin-left":"4px"},size:12},{default:u((()=>[f(y($))])),_:1})])),_:1})])])),suffix:u((()=>[f(M,{size:"small"},{default:u((()=>[p("数量")])),_:1})])),_:1},8,["value"]),m("div",{class:"statistic-footer"},[m("div",{class:"footer-item"},[m("span",null,"上月"),m("span",{class:g(j.value>z.value?"red":"green")},[p(v(z.value)+" ",1),f(a,null,{default:u((()=>[f(y(k))])),_:1})],2)])])]),r((c(),d(C,{class:"bills-items"},{default:u((()=>[(c(!0),_(h,null,x(D.value,((t,e)=>(c(),d(C,{key:e},{default:u((()=>[t.payer?(c(),d(C,{key:0,style:{margin:"15px 10px"}},{default:u((()=>[t.amount&&0!=t.amount?(c(),d(C,{key:0,style:{display:"flex","justify-content":"space-between","align-items":"flex-start"}},{default:u((()=>[f(T,{style:{"margin-right":"15px","min-width":"40px"},shape:"circle",src:t.payer.avatar},null,8,["src"]),f(C,{style:{display:"flex","flex-grow":"2",padding:"0 0 16px 0","border-bottom":"1px solid #E4E7ED"}},{default:u((()=>[f(C,{style:{display:"grid","flex-grow":"2"}},{default:u((()=>[f(M,{style:{color:"#191919",padding:"0 0 8px 0","line-height":"12px"},truncated:""},{default:u((()=>[p(v(t.amount>0?"来自":"回退")+" "+v(t.payer.nickname)+" ",1),t.comment?(c(),d(M,{key:0,style:{padding:"0 0 0 15px"}},{default:u((()=>[p("- "+v(t.comment),1)])),_:2},1024)):w("",!0)])),_:2},1024),f(M,{style:{color:"#909399"},size:"small"},{default:u((()=>[f(V,{format:"M月dd日 hh:mm",date:t.timestamp},null,8,["date"]),p(" "+v(t.channel+"-"+("date"==t.type?"天数":"次数")),1)])),_:2},1024)])),_:2},1024),f(C,{style:{"font-weight":"bold","min-width":"50px","text-align":"right"}},{default:u((()=>[f(M,{style:E(t.amount>0?"color:#FEC202;":"oolor:#191919")},{default:u((()=>[p(v((t.amount>0?"+":"")+t.amount),1)])),_:2},1032,["style"])])),_:2},1024)])),_:2},1024)])),_:2},1024)):w("",!0)])),_:2},1024)):w("",!0)])),_:2},1024)))),128)),f(C,{style:{display:"flex","justify-content":"center",margin:"25px 0 50px 0"}},{default:u((()=>[y(J)?(c(),d(M,{key:0,style:{color:"#8b8e94"}},{default:u((()=>[p(" 暂无更多 ")])),_:1})):w("",!0)])),_:1})])),_:1})),[[Q,B.value]])])),_:1})),[[Y,P]])}}},[["__scopeId","data-v-1c4bc4c2"]]);export{M as default};
