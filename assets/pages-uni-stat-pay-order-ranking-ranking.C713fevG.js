import{_ as e,Y as a,n as t,r as n,b as l,c as s,w as r,i,aN as o,d,e as u,f as c,j as p,o as m,l as f,m as h,x as _,p as g,q as y,F as b,u as x,t as C,z as q}from"./index-ChMB-C2t.js";import{_ as $}from"./uni-stat-breadcrumb.mR06vjM8.js";import{_ as k}from"./download-excel.DURbGBmN.js";import{_ as T}from"./uni-data-select.CxWVu1M3.js";import{_ as v}from"./uni-stat-tabs.BieK4wFj.js";import{_ as w}from"./uni-pagination.BkPProof.js";import{_ as V}from"./unicloud-db.BatFX0cf.js";import{e as D,f as j}from"./uni-pay-orders.CqmY5J70.js";import{g as S,s as z}from"./util.CRPBdIOi.js";import{t as E}from"./timeUtil.wwvjgelv.js";import"./uni-tooltip.C01MddUW.js";const I=a.database(),U={ascending:"asc",descending:"desc"};const L=e({data:()=>({collectionList:"uni-pay-orders",query:{appid:"",platform_id:"",uni_platform:"",version:"",pay_date:[],channel_code:""},where:"",orderby:"total_fee desc",orderByFieldName:"",selectedIndexs:[],options:{pageSize:20,pageCurrent:1,filterData:{},...D},imageStyles:{width:64,height:64},exportExcel:{filename:"价值用户排行.xls",type:"xls",fields:{"用户ID":"user_id","用户昵称":"nickname","支付金额":"total_fee","订单数量":"count"}},exportExcelData:[],dateTabs:{time:[],timeStr:"",index:null,list:[{_id:0,name:"今天"},{_id:1,name:"昨天"},{_id:7,name:"最近七天"},{_id:30,name:"最近30天"},{_id:90,name:"最近90天"}]}}),onLoad(){this._filter={}},onReady(){},methods:{payDatePicker(e){this.query.pay_date=e,this.search()},onqueryload(e){this.exportExcelData=e},getWhere(){let e="status>0",{pay_date:a,appid:t,version:n,uni_platform:l,channel_code:s}=this.query;return a&&2==a.length&&(e+=` && pay_date>=${a[0]} && pay_date<=${a[1]}`),t&&(e+=` && appid=='${t}'`),n&&(e+=` && stat_data.app_version=='${n}'`),l&&(e+=` && stat_data.platform=='${l}'`),s&&(e+=` && stat_data.channel=='${s}'`),e=e.trim(),console.log("where: ",e),e},search(){if(!this.query.appid)return;const e=this.getWhere();this.where=e,this.$nextTick((()=>{this.loadData()}))},loadData(e=!0){this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.selectedIndexs.length=0,this.$refs.table.clearSelection(),this.$refs.udb.loadData({current:e.current})},navigateTo(e,a){t({url:e,events:{refreshData:()=>{this.loadData(a)}}})},selectedItems(){var e=this.$refs.udb.dataList;return this.selectedIndexs.map((a=>e[a]._id))},delTable(){this.$refs.udb.remove(this.selectedItems(),{success:e=>{this.$refs.table.clearSelection()}})},selectionChange(e){this.selectedIndexs=e.detail.index},sortChange(e,a){this.orderByFieldName=a,e.order?this.orderby=a+" "+U[e.order]:this.orderby="",this.$refs.table.clearSelection(),this.$nextTick((()=>{this.$refs.udb.loadData()}))},filterChange(e,a){this._filter[a]={type:e.filterType,value:e.filter};let t=j(this._filter,I.command);Object.keys(t).length?this.where=t:this.where="",this.$nextTick((()=>{this.$refs.udb.loadData()}))},platformChange(e,a,t,n){this.query.version=0,this.query.uni_platform=n.code},nameFormat:e=>e.user_id?e.nickname?`${e.user_id}（${e.nickname}）`:e.user_id:"匿名用户",pageToUser(e){let{user_id:a}=e;t({url:`/pages/system/user/list?id=${a}`})},pageToOrder(e){let{user_id:a}=e;t({url:`/pages/uni-stat/pay-order/list/list?user_id=${a}`})},dateTabsChange(e,a){this.dateTabs.index=a;let t=S(e),n=E.getOffsetStartAndEnd("day",0).endTime;1==e&&(n=E.getOffsetStartAndEnd("day",0,t).endTime),this.query.pay_date=[t,n]}},watch:{query:{deep:!0,handler(e){this.search()}}},computed:{versionQuery(){const{appid:e,uni_platform:a}=this.query;return z({appid:e,uni_platform:a})},channelQuery(){const{appid:e,platform_id:a}=this.query;return z({appid:e,platform_id:a})}}},[["render",function(e,a,t,D,j,S){const z=n(l("uni-stat-breadcrumb"),$),E=i,I=x,U=n(l("download-excel"),k),L=n(l("uni-data-select"),T),F=n(l("uni-stat-tabs"),v),O=n(l("uni-datetime-picker"),o),Q=n(l("uni-th"),d),P=n(l("uni-tr"),u),N=n(l("uni-td"),c),A=q,B=n(l("uni-table"),p),W=n(l("uni-pagination"),w),R=n(l("unicloud-db"),V);return m(),s(E,null,{default:r((()=>[f(E,{class:"uni-header"},{default:r((()=>[f(E,{class:"uni-group"},{default:r((()=>[f(z)])),_:1}),f(E,{class:"uni-group"},{default:r((()=>[f(I,{class:"uni-button",type:"default",size:"mini",onClick:S.search},{default:r((()=>[h("搜索")])),_:1},8,["onClick"]),f(U,{class:"hide-on-phone",fields:j.exportExcel.fields,data:j.exportExcelData,type:j.exportExcel.type,name:j.exportExcel.filename},{default:r((()=>[f(I,{class:"uni-button",type:"primary",size:"mini"},{default:r((()=>[h("导出 Excel")])),_:1})])),_:1},8,["fields","data","type","name"])])),_:1})])),_:1}),f(E,{class:"uni-container"},{default:r((()=>[f(E,{class:"uni-stat--x flex p-1015"},{default:r((()=>[f(L,{collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",defItem:1,label:"应用选择",modelValue:j.query.appid,"onUpdate:modelValue":a[0]||(a[0]=e=>j.query.appid=e),clear:!1},null,8,["modelValue"]),f(L,{collection:"opendb-app-versions",where:S.versionQuery,class:"ml-m",field:"_id as value, version as text, uni_platform as label, create_date as date",format:"{label} - {text}",orderby:"date desc",label:"版本选择",modelValue:j.query.version_id,"onUpdate:modelValue":a[1]||(a[1]=e=>j.query.version_id=e)},null,8,["where","modelValue"])])),_:1}),f(E,{class:"uni-stat--x",style:{"margin-bottom":"0"}},{default:r((()=>[f(F,{label:"平台选择",type:"boldLine",mode:"platform",modelValue:j.query.platform_id,"onUpdate:modelValue":a[2]||(a[2]=e=>j.query.platform_id=e),onChange:S.platformChange},null,8,["modelValue","onChange"]),j.query.platform_id&&-1===j.query.platform_id.indexOf("==")?(m(),s(L,{key:0,ref:"version-select",collection:"uni-stat-app-channels",where:S.channelQuery,class:"p-channel",field:"channel_code as value, channel_name as text",orderby:"text asc",label:"渠道/场景值选择",modelValue:j.query.channel_code,"onUpdate:modelValue":a[3]||(a[3]=e=>j.query.channel_code=e)},null,8,["where","modelValue"])):_("",!0)])),_:1}),f(E,{class:"flex"},{default:r((()=>[f(F,{type:"box",current:j.dateTabs.index,tabs:j.dateTabs.list,onChange:S.dateTabsChange},null,8,["current","tabs","onChange"]),f(O,{type:"datetimerange",modelValue:j.query.pay_date,"onUpdate:modelValue":a[4]||(a[4]=e=>j.query.pay_date=e),end:Date.now(),"return-type":"timestamp","clear-icon":!0,class:"uni-stat-datetime-picker",onChange:a[5]||(a[5]=e=>j.dateTabs.index=null)},null,8,["modelValue","end"])])),_:1}),f(R,{ref:"udb",collection:j.collectionList,field:"user_id,nickname,uni_platform,status,total_fee,refund_fee,appid,pay_date",where:j.where,"page-data":"replace",orderby:j.orderby,getcount:!0,"page-size":j.options.pageSize,"page-current":j.options.pageCurrent,groupby:"user_id","group-field":"sum(total_fee) as total_fee,sum(refund_fee) as refund_fee, sum(subtract(total_fee,refund_fee)) as reality_fee, sum(1) as count,last(nickname) as nickname",options:j.options,loadtime:"manual",onLoad:S.onqueryload},{default:r((({data:e,pagination:t,loading:n,error:l,options:i})=>[f(B,{ref:"table",loading:n,emptyText:l.message||n?"请求中...":"没有更多数据",border:"",stripe:"",type:"",style:{"min-height":"900px"},onSelectionChange:S.selectionChange},{default:r((()=>[f(P,null,{default:r((()=>[f(Q,{align:"center"},{default:r((()=>[h("排名")])),_:1}),f(Q,{align:"center",sortable:"",onSortChange:a[6]||(a[6]=e=>S.sortChange(e,"user_id"))},{default:r((()=>[h("用户")])),_:1}),f(Q,{align:"center",sortable:"",onSortChange:a[7]||(a[7]=e=>S.sortChange(e,"reality_fee"))},{default:r((()=>[h("支付金额（不含退款）")])),_:1}),f(Q,{align:"center",sortable:"",onSortChange:a[8]||(a[8]=e=>S.sortChange(e,"count"))},{default:r((()=>[h("订单数量")])),_:1})])),_:1}),(m(!0),g(b,null,y(e,((e,a)=>(m(),s(P,{key:a},{default:r((()=>[f(N,{align:"center"},{default:r((()=>[h(C(parseInt(a+1+(t.current-1)*t.size)),1)])),_:2},1024),f(N,{align:"center"},{default:r((()=>[f(A,{class:"text-btn",onClick:a=>S.pageToUser(e)},{default:r((()=>[h(C(S.nameFormat(e)),1)])),_:2},1032,["onClick"])])),_:2},1024),f(N,{align:"center"},{default:r((()=>[h(C((e.reality_fee/100).toFixed(2)),1)])),_:2},1024),f(N,{align:"center"},{default:r((()=>[f(A,{class:"text-btn",onClick:a=>S.pageToOrder(e)},{default:r((()=>[h(C(e.count),1)])),_:2},1032,["onClick"])])),_:2},1024)])),_:2},1024)))),128))])),_:2},1032,["loading","emptyText","onSelectionChange"]),f(E,{class:"uni-pagination-box"},{default:r((()=>[f(W,{"show-icon":"","page-size":t.size,modelValue:t.current,"onUpdate:modelValue":e=>t.current=e,total:t.count,onChange:S.onPageChanged},null,8,["page-size","modelValue","onUpdate:modelValue","total","onChange"])])),_:2},1024)])),_:1},8,["collection","where","orderby","page-size","page-current","options","onLoad"])])),_:1})])),_:1})}],["__scopeId","data-v-05330111"]]);export{L as default};
