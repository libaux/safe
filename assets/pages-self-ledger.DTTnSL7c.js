import{_ as t,B as e,Y as a,A as l,C as s,r as i,b as n,am as o,c as r,w as d,i as u,o as c,T as f,D as m,l as p,m as y,an as g,J as v,t as x,p as _,q as h,F as w,x as b,ao as $,ap as k,v as F}from"./index-CTufusbk.js";import{_ as E}from"./uni-dateformat.C-wpljgu.js";const M=t({__name:"ledger",setup(t){e((async()=>{const t=T(0),e=C(),a=C(-1);j.value=await e,z.value=await a,await t}));const M=a.databaseForJQL(),D=l([]),j=l(0),z=l(0),B=l(!0),I=l(0),J=l(!1),P=async()=>{I.value+=1,await T(I.value)},T=async t=>{var e;if(J.value)return;const a=(null==(e=(await M.collection("libraux-ledger").where("uid==$cloudEnv_uid").field(`slice(bills, ${20*t}, 20) as partBills`).get()).data[0])?void 0:e.partBills)||[];B.value=!1;const l=[];for(let i of a){const t=Y(i.payer);l.push(t)}const s=await Promise.all(l);for(let i in a)for(let t of s)a[i].payer==t._id&&(a[i].payer=t);D.value.push(...a),a.length<20&&(J.value=!0)},Y=async t=>(await M.collection("libraux-users").where({_id:t}).field("avatar,nickname,mobile,school,vip_cnts,vip_days").get()).data[0]||{},C=async(t=0)=>{var e;const l=a.databaseForJQL(),s=L(t),i=(null==(e=(await l.collection("libraux-ledger").where("uid==$cloudEnv_uid").field(`reduce(filter(bills, "it", and(\n\t\t\t\t\t\t\tgte("$$it.timestamp", ${s[0]}),\n\t\t\t\t\t\t\tlt("$$it.timestamp", ${s[1]})\n\t\t\t\t\t\t\t)),\n\t\t\t\t\t\t\t0, add("$$value", "$$this.amount")) as sumVIP`).get()).data[0])?void 0:e.sumVIP.toFixed(0))||0;return Number(i)},L=(t=null)=>{const e=new Date,a=[];return null==t||(t>0&&t<=12?e.setMonth(t-1):t<0&&e.setMonth(e.getMonth()+t)),a[0]=new Date(e.getFullYear(),e.getMonth(),1).getTime(),a[1]=new Date(e.getFullYear(),e.getMonth()+1,0,23,59,59).getTime(),a};return(t,e)=>{const a=s("el-icon"),l=s("el-tooltip"),M=s("el-text"),I=s("el-statistic"),T=s("el-avatar"),Y=i(n("uni-dateformat"),E),C=u,L=o("loading"),Q=o("infinite-scroll");return c(),r(C,null,{default:d((()=>[f((c(),r(C,{class:"scrollbar-container","infinite-scroll-distance":1,"infinite-scroll-immediate":!1},{default:d((()=>[m("div",{class:"statistic-card",style:{"text-align":"center"}},[p(I,{value:j.value},{title:d((()=>[m("div",{style:{display:"inline-flex","align-items":"center"}},[y("本月总计 "),p(l,{effect:"dark",content:"本月累计的天数与次数净值总和",placement:"top"},{default:d((()=>[p(a,{style:{"margin-left":"4px"},size:12},{default:d((()=>[p(g($))])),_:1})])),_:1})])])),suffix:d((()=>[p(M,{size:"small"},{default:d((()=>[y("数量")])),_:1})])),_:1},8,["value"]),m("div",{class:"statistic-footer"},[m("div",{class:"footer-item"},[m("span",null,"上月"),m("span",{class:v(j.value>z.value?"red":"green")},[y(x(z.value)+" ",1),p(a,null,{default:d((()=>[p(g(k))])),_:1})],2)])])]),f((c(),r(C,{class:"bills-items"},{default:d((()=>[(c(!0),_(w,null,h(D.value,((t,e)=>(c(),r(C,{key:e},{default:d((()=>[t.payer?(c(),r(C,{key:0,style:{margin:"15px 10px"}},{default:d((()=>[t.amount&&0!=t.amount?(c(),r(C,{key:0,style:{display:"flex","justify-content":"space-between","align-items":"flex-start"}},{default:d((()=>[p(T,{style:{"margin-right":"15px","min-width":"40px"},shape:"circle",src:t.payer.avatar},null,8,["src"]),p(C,{style:{display:"flex","flex-grow":"2",padding:"0 0 16px 0","border-bottom":"1px solid #E4E7ED"}},{default:d((()=>[p(C,{style:{display:"grid","flex-grow":"2"}},{default:d((()=>[p(M,{style:{color:"#191919",padding:"0 0 8px 0","line-height":"12px"},truncated:""},{default:d((()=>[y(x(t.amount>0?"来自":"回退")+" "+x(t.payer.nickname)+" ",1),t.comment?(c(),r(M,{key:0,style:{padding:"0 0 0 15px"}},{default:d((()=>[y("- "+x(t.comment),1)])),_:2},1024)):b("",!0)])),_:2},1024),p(M,{style:{color:"#909399"},size:"small"},{default:d((()=>[p(Y,{format:"M月dd日 hh:mm",date:t.timestamp},null,8,["date"]),y(" "+x(t.channel+"-"+("date"==t.type?"天数":"次数")),1)])),_:2},1024)])),_:2},1024),p(C,{style:{"font-weight":"bold","min-width":"50px","text-align":"right"}},{default:d((()=>[p(M,{style:F(t.amount>0?"color:#FEC202;":"oolor:#191919")},{default:d((()=>[y(x((t.amount>0?"+":"")+t.amount),1)])),_:2},1032,["style"])])),_:2},1024)])),_:2},1024)])),_:2},1024)):b("",!0)])),_:2},1024)):b("",!0)])),_:2},1024)))),128)),p(C,{style:{display:"flex","justify-content":"center",margin:"25px 0 50px 0"}},{default:d((()=>[J.value?(c(),r(M,{key:0,style:{color:"#8b8e94","margin-bottom":"25px"}},{default:d((()=>[y(" 暂无更多 ")])),_:1})):b("",!0)])),_:1})])),_:1})),[[L,B.value]])])),_:1})),[[Q,P]])])),_:1})}}},[["__scopeId","data-v-6f602ff4"]]);export{M as default};
