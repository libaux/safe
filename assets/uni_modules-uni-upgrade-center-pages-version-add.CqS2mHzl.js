import{_ as e,Y as a,R as t,h as l,s as i,a as s,O as n,r as o,b as r,c as d,w as u,i as m,o as p,l as c,m as f,t as h,x as _,p as b,q as y,F as D,T as g,U as V,u as k,z as v,V as x,W as C,X as S,Z as U,$ as w}from"./index-nI17xpur.js";import{_ as W}from"./uni-easyinput.Bgc1tsO3.js";import{_ as T}from"./uni-forms-item.Dcp4oYwL.js";import{_ as F}from"./uni-data-checkbox.CKcvFTgL.js";import{_ as G,a as j,b as O}from"./uni-card.BKXm99-Q.js";import{_ as q}from"./uni-forms.C-pi59MJ.js";import{a as I,f as L}from"./version_add_detail_mixin.C70tIaVe.js";import{a as z}from"./utils.3Mrbv0Oc.js";import"./uni-load-more.l5YQeopO.js";const A=a.database();A.command;const P=z;const E=e({mixins:[I],data:()=>({latestVersion:"0.0.0",lastVersionId:""}),async onLoad({appid:e,name:a,type:t}){if(e&&t&&a){const l=await this.getStoreList(e);this.formData={...this.formData,appid:e,name:a,type:t,store_list:l},this.latestStableData=await this.getDetail(e,t),!this.isWGT&&this.latestStableData.length&&this.setFormData("Android"),this.isWGT&&this.rules.min_uni_version.rules.push({required:!0})}},watch:{isiOS(e){e||!this.hasPackage?this.formData.url="":this.formData.url=this.appFileList.url},"formData.platform"(e){this.setFormData(e)}},methods:{setFormData(e){t({mask:!0}),this.latestVersion="0.0.0",this.lastVersionId="";const a=this.getData(this.latestStableData,e)[0];if(a){const{_id:e,version:t,name:l,platform:i,min_uni_version:s,url:n}=a;this.lastVersionId=e,this.latestVersion=t,this.formData.name=l,this.isWGT?this.formData.min_uni_version=s:(delete this.formData.min_uni_version,this.formData.platform=i[0],this.isiOS&&(this.formData.url=n))}else this.isWGT&&(this.formData.min_uni_version="");l()},submit(){t({mask:!0}),this.$refs.form.validate(["store_list"]).then((e=>{if(function(e="0",a="0"){e=String(e).split("."),a=String(a).split(".");const t=Math.min(e.length,a.length);let l=0;for(let i=0;i<t;i++){const t=Number(e[i]),s=Number(a[i]);if(t>s){l=1;break}if(t<s){l=-1;break}}if(0===l&&e.length!==a.length){const i=e.length>a.length,s=i?e:a;for(let e=t;e<s.length;e++)if(Number(s[e])>0){l=i?1:-1;break}}return l}(this.latestVersion,e.version)>=0)throw i({content:`版本号必须大于当前已上线版本（${this.latestVersion}）`,showCancel:!1}),new Error("版本号必须大于已上线版本（${this.latestVersion}）");this.isWGT||(e.platform=[e.platform]),(this.isiOS||this.isWGT)&&delete e.store_list,e.store_list&&e.store_list.forEach((e=>{e.priority=parseFloat(e.priority)})),this.submitForm(e)})).catch((e=>{l()}))},async submitForm(e){e=this.createCenterRecord(e);const a=A.collection(P);let t,o=[];this.isWGT||(o=await this.getDetail(e.appid,e.type,this.createStatQuery(e))),o.length?(e.create_date=Date.now(),t=a.doc(o[0]._id).update(e)):t=a.add(e),t.then((async t=>{e.stable_publish&&this.lastVersionId&&await a.doc(this.lastVersionId).update({stable_publish:!1}),s({title:"新增成功"}),this.getOpenerEventChannel().emit("refreshData"),setTimeout((()=>n()),500)})).catch((e=>{i({content:e.message||"请求服务失败",showCancel:!1})})).finally((()=>{l()}))},getDetail:(e,a,s={})=>(t({mask:!0}),A.collection(P).where(Object.assign({appid:e,type:a,stable_publish:!0},s)).field(L).get().then((e=>e.result.data)).catch((e=>{i({content:e.message||"请求服务失败",showCancel:!1})})).finally((()=>{l()}))),getData:(e=[],a)=>"string"==typeof a?e.filter((e=>e.platform.includes(a))):e.filter((e=>e.platform.toString()===a.toString())),back(){i({title:"取消发布",content:this.hasPackage?"将会删除已上传的包":void 0,success:e=>{e.confirm&&(this.hasPackage&&this.deleteFile([this.appFileList.url]),n())}})}}},[["render",function(e,a,t,l,i,s){const n=m,I=o(r("uni-easyinput"),W),L=o(r("uni-forms-item"),T),z=V,A=o(r("uni-data-checkbox"),F),P=o(r("show-info"),G),E=k,N=v,$=o(r("uni-file-picker"),j),M=S,R=U,Q=w,X=o(r("uni-card"),O),Y=x,Z=o(r("uni-forms"),q);return p(),d(n,{class:"uni-container"},{default:u((()=>[c(n,{class:"uni-header"},{default:u((()=>[c(n,{class:"uni-group"},{default:u((()=>[c(n,{class:"uni-title"},{default:u((()=>[f("包类型")])),_:1}),c(n,{class:"uni-sub-title"},{default:u((()=>[f(h(e.type_valuetotext[e.formData.type]),1)])),_:1})])),_:1})])),_:1}),c(Z,{ref:"form",value:e.formData,validateTrigger:"bind",labelWidth:e.labelWidth},{default:u((()=>[c(L,{name:"appid",label:"AppID",required:""},{default:u((()=>[c(I,{disabled:!0,modelValue:e.formData.appid,"onUpdate:modelValue":a[0]||(a[0]=a=>e.formData.appid=a),trim:"both"},null,8,["modelValue"])])),_:1}),c(L,{name:"name",label:"应用名称"},{default:u((()=>[c(I,{disabled:!0,modelValue:e.formData.name,"onUpdate:modelValue":a[1]||(a[1]=a=>e.formData.name=a),trim:"both"},null,8,["modelValue"])])),_:1}),c(L,{name:"title",label:"更新标题"},{default:u((()=>[c(I,{placeholder:"更新标题",modelValue:e.formData.title,"onUpdate:modelValue":a[2]||(a[2]=a=>e.formData.title=a)},null,8,["modelValue"])])),_:1}),c(L,{name:"contents",label:"更新内容",required:""},{default:u((()=>[c(z,{"auto-height":"",style:{"box-sizing":"content-box"},onInput:a[3]||(a[3]=a=>e.binddata("contents",a.detail.value)),class:"uni-textarea-border",value:e.formData.contents,"onUpdate:value":a[4]||(a[4]=a=>e.formData.contents=a)},null,8,["value"])])),_:1}),c(L,{name:"platform",label:"平台",required:""},{default:u((()=>[c(A,{multiple:e.isWGT,modelValue:e.formData.platform,"onUpdate:modelValue":a[5]||(a[5]=a=>e.formData.platform=a),localdata:e.platformLocaldata},null,8,["multiple","modelValue","localdata"])])),_:1}),c(L,{name:"version",label:"版本号",required:""},{default:u((()=>[c(I,{modelValue:e.formData.version,"onUpdate:modelValue":a[6]||(a[6]=a=>e.formData.version=a),placeholder:"当前包版本号，必须大于当前线上发行版本号"},null,8,["modelValue"])])),_:1}),e.isWGT?(p(),d(L,{key:"min_uni_version",name:"min_uni_version",label:"原生App最低版本",required:e.isWGT},{default:u((()=>[c(I,{placeholder:"原生App最低版本",modelValue:e.formData.min_uni_version,"onUpdate:modelValue":a[7]||(a[7]=a=>e.formData.min_uni_version=a)},null,8,["modelValue"]),c(P,{content:e.minUniVersionContent},null,8,["content"])])),_:1},8,["required"])):_("",!0),e.isiOS?_("",!0):(p(),d(L,{key:1,label:"上传apk包"},{default:u((()=>[c($,{modelValue:e.appFileList,"onUpdate:modelValue":a[8]||(a[8]=a=>e.appFileList=a),"file-extname":e.fileExtname,disabled:e.hasPackage,returnType:"object","file-mediatype":"all",limit:"1",onSuccess:e.packageUploadSuccess,onDelete:e.packageDelete},{default:u((()=>[c(n,{class:"flex"},{default:u((()=>[c(E,{type:"primary",size:"mini",onClick:e.selectFile,style:{margin:"0"}},{default:u((()=>[f("选择文件")])),_:1},8,["onClick"]),c(N,{style:{padding:"10px","font-size":"12px",color:"#666"}},{default:u((()=>[f("上传apk到当前服务空间的云存储中，上传成功后，会自动使用云存储地址填充下载链接")])),_:1}),c(N,{class:"uni-sub-title",style:{"font-size":"12px"}},{default:u((()=>[f("上传文件后同步到各地cdn缓存节点有延迟。请适当等候再提交新版信息入库，触发客户端更新提示。")])),_:1})])),_:1})])),_:1},8,["modelValue","file-extname","disabled","onSuccess","onDelete"]),e.hasPackage?(p(),d(N,{key:0,style:{"padding-left":"20px",color:"#a8a8a8"}},{default:u((()=>[f(h(Number(e.appFileList.size/1024/1024).toFixed(2))+"M",1)])),_:1})):_("",!0)])),_:1})),c(L,{key:"url",name:"url",label:e.isiOS?"AppStore":"下载链接",required:""},{default:u((()=>[c(I,{placeholder:"链接",modelValue:e.formData.url,"onUpdate:modelValue":a[9]||(a[9]=a=>e.formData.url=a),maxlength:-1},null,8,["modelValue"])])),_:1},8,["label"]),e.isiOS||e.isWGT||!e.formData.store_list.length?_("",!0):(p(),d(L,{label:"Android应用市场",labelWidth:"125px",key:"store_list",name:"store_list"},{default:u((()=>[c(n,{style:{flex:"1"}},{default:u((()=>[(p(!0),b(D,null,y(e.formData.store_list,(a=>(p(),d(n,{key:a.id},{default:u((()=>[c(X,{style:{margin:"0px 0px 20px 0px"}},{default:u((()=>[c(n,{style:{display:"flex"}},{default:u((()=>[c(Q,{style:{"user-select":"none"},onChange:({detail:{value:e}})=>{a.enable=!!e.length}},{default:u((()=>[c(R,{class:"title_padding"},{default:u((()=>[c(M,{value:"scheme",checked:a.enable},null,8,["checked"]),c(N,null,{default:u((()=>[f("是否启用")])),_:1})])),_:2},1024)])),_:2},1032,["onChange"])])),_:2},1024),c(L,{label:"商店名称"},{default:u((()=>[c(I,{disabled:"",modelValue:a.name,"onUpdate:modelValue":e=>a.name=e,trim:"both"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024),c(L,{label:"Scheme"},{default:u((()=>[c(I,{disabled:"",modelValue:a.scheme,"onUpdate:modelValue":e=>a.scheme=e,trim:"both"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024),c(L,{label:"优先级"},{default:u((()=>[c(I,{modelValue:a.priority,"onUpdate:modelValue":e=>a.priority=e,type:"number"},null,8,["modelValue","onUpdate:modelValue"]),c(P,{top:-100,left:-180,content:e.priorityContent},null,8,["content"])])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1})),e.isWGT?(p(),d(L,{key:"is_silently",name:"is_silently",label:"静默更新"},{default:u((()=>[c(Y,{onChange:a[10]||(a[10]=a=>e.binddata("is_silently",a.detail.value)),checked:e.formData.is_silently},null,8,["checked"]),c(P,{top:-80,content:e.silentlyContent},null,8,["content"])])),_:1})):_("",!0),e.isiOS?_("",!0):(p(),d(L,{key:"is_mandatory",name:"is_mandatory",label:"强制更新"},{default:u((()=>[c(Y,{onChange:a[11]||(a[11]=a=>e.binddata("is_mandatory",a.detail.value)),checked:e.formData.is_mandatory},null,8,["checked"]),c(P,{content:e.mandatoryContent},null,8,["content"])])),_:1})),c(L,{name:"stable_publish",label:"上线发行"},{default:u((()=>[c(Y,{onChange:a[12]||(a[12]=a=>e.binddata("stable_publish",a.detail.value)),checked:e.formData.stable_publish},null,8,["checked"]),c(P,{top:-40,content:e.stablePublishContent2},null,8,["content"])])),_:1}),g(c(L,{name:"type",label:"安装包类型"},{default:u((()=>[c(A,{modelValue:e.formData.type,"onUpdate:modelValue":a[13]||(a[13]=a=>e.formData.type=a),localdata:e.formOptions.type_localdata},null,8,["modelValue","localdata"])])),_:1},512),[[C,!1]]),c(n,{class:"uni-button-group"},{default:u((()=>[c(E,{type:"primary",class:"uni-button",style:{width:"100px"},onClick:s.submit},{default:u((()=>[f("发布")])),_:1},8,["onClick"]),c(E,{type:"warn",class:"uni-button",style:{width:"100px","margin-left":"15px"},onClick:s.back},{default:u((()=>[f("取消")])),_:1},8,["onClick"])])),_:1})])),_:1},8,["value","labelWidth"])])),_:1})}],["__scopeId","data-v-b471f01c"]]);export{E as default};
